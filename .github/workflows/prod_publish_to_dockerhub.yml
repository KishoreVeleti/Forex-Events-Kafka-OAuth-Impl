name: Production Publish to Docker Hub

on:
  workflow_dispatch:   # Manual trigger only

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: write    # Needed for committing + tagging
      packages: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Required for tagging

      - name: Set up Git user (for commits)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Read and increment version
        id: version
        run: |
          VERSION_FILE="version.txt"
          if [ ! -f "$VERSION_FILE" ]; then
            echo "0.0.0" > "$VERSION_FILE"
          fi

          OLD_VERSION=$(cat $VERSION_FILE | tr -d '\n' | tr -d '\r')
          echo "Current version: $OLD_VERSION"

          # Default fallback if invalid or empty
          if [[ ! $OLD_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format or empty. Setting to 1.0.0"
            NEW_VERSION="1.0.0"
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$OLD_VERSION"

            # Special case: if 0.0.0 â†’ jump to 1.0.0
            if [[ "$MAJOR" == "0" && "$MINOR" == "0" && "$PATCH" == "0" ]]; then
              NEW_VERSION="1.0.0"
            else
              MINOR=$((MINOR + 1))
              PATCH=0
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            fi
          fi

          echo "$NEW_VERSION" | tee $VERSION_FILE
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Commit and tag new version
          git add $VERSION_FILE
          git commit -m "ci: bump version to $NEW_VERSION [skip ci]"
          git tag "v$NEW_VERSION"
          git push origin HEAD:main
          git push origin "v$NEW_VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Define image name and timestamp tag
        id: vars
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/forex-events-kafka-oauth-impl
          TIMESTAMP=$(date +"%Y-%m-%d-%H-%M-%S")
          VERSION=${{ steps.version.outputs.NEW_VERSION }}
          FULL_TAG="${VERSION}-${TIMESTAMP}"
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "FULL_TAG=${FULL_TAG}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build and push multi-arch Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: devops/deployment/prod/dockerhub/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.vars.outputs.IMAGE_NAME }}:${{ steps.vars.outputs.FULL_TAG }}
            ${{ steps.vars.outputs.IMAGE_NAME }}:${{ steps.vars.outputs.VERSION }}
            ${{ steps.vars.outputs.IMAGE_NAME }}:latest

